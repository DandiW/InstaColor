<!doctype html>
<html>
<head>
	<link rel="stylesheet" href="/static/style.css" type="text/css" />

	<script type="text/javascript">
		function pageLoaded() {
			var elements = document.getElementsByClassName("frame");
			var div_height = new Array(elements.length);
			div_height[0] = 24;
			for (var i = 0; i < elements.length; i++) {
				var element = elements[i];
				var ident = element.id;
				var thumbnailURL = element.getAttribute("data-thumbnailURL");
				var year = parseInt(element.getAttribute("data-year"));
				var month = parseInt(element.getAttribute("data-month"));
				var day = parseInt(element.getAttribute("data-day"));
				if (i>=1){
					var prev=(parseInt(elements[i-1].getAttribute("data-year"))-2013)*365+(parseInt(elements[i-1].getAttribute("data-month"))-1)*31+parseInt(elements[i-1].getAttribute("data-day"))-1;
					var now=(year-2013)*365+(month-1)*31+(day-1);
					var time_diff = prev-now;
					div_height[i]=time_diff;
				}
				var request = new XMLHttpRequest();
				request.addEventListener("load", function() {
					var response = JSON.parse(this.responseText);
					var color = response.color;
					document.getElementById(response.identifier).style.backgroundColor = color;
				});
				request.open("GET", "/analyzeColor?id=" + ident + "&url=" + encodeURIComponent(thumbnailURL));
				request.send();
                
                var request2 = new XMLHttpRequest();
				request2.addEventListener("load", function() {
					var response = JSON.parse(this.responseText);
					var label = response.label;
                    if (label != "Unknown") {
                        var emojiLabel = document.getElementById(response.identifier).getElementsByClassName("emoticon")[0];
                        emojiLabel.src = "/static/images/" + label;
						emojiLabel.style.visibility = "visible";
                    }
				});
				request2.open("GET", "/analyzeFaceSentiment?id=" + ident + "&url=" + encodeURIComponent(thumbnailURL));
				request2.send();
			}
			var total=0;
			for (var i = 1; i < elements.length; i++) {
				total = total + div_height[i];
			}
			for (var i = 1; i < elements.length; i++) {
				var final_height = div_height[i]*24*(elements.length-1)/total;
				if(final_height<24){
					final_height=24;
				}
				if(final_height>85){
					final_height=85;
				}
				elements[i].setAttribute("style","height:"+final_height+"px");
			}
		}

		function toggleSidebar() {
			var sidebar = document.getElementById("sidebar");
			var sidebarAnchor = document.getElementById("sidebarAnchor");
			if (sidebar.style.visibility == "visible") {
				sidebar.style.visibility = "hidden";
				sidebarAnchor.innerText = "Show Filter >";
			} else {
				sidebar.style.visibility = "visible";
				sidebarAnchor.innerText = "Hide Filters >";
			}
		}
    </script>



    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);
      function drawChart() {
		var elements = document.getElementsByClassName("frame");
		var anger_count = 0;
		var contempt_count = 0;
		var disgust_count = 0;
		var fear_count = 0;
		var happiness_count = 0;
		var neutral_count = 0;
		var sadness_count = 0;
		var surprise_count = 0;
		var unknown_count = 0;
			for (var i = 0; i < elements.length; i++) {
				var element = elements[i];
				var ident = element.id;
				var thumbnailURL = element.getAttribute("data-thumbnailURL");
				var request = new XMLHttpRequest();
				request.addEventListener("load", function() {
					var response = JSON.parse(this.responseText);
					var label = response.raw_label;
					console.log(label);
					switch(label){
						case "anger":
							anger_count++;
							break;
						case "contempt":
							contempt_count++;
							break;
						case "disgust":
							disgust_count++;
							break;
						case "fear":
							fear_count++;
							break;
						case "happiness":
							happiness_count++;
							break;
						case "neutral":
							neutral_count++;
							break;
						case "sadness":
							sadness_count++;
							break;
						case "surprise":
							surprise_count++;
							break;
						default:
							unknown_count++;
					}
				});
				//ident = "1222948688897299217_469024147";
				//thumbnailURL = "https://scontent.cdninstagram.com/t51.2885-15/s640x640/sh0.08/e35/12965844_192621721123594_583847765_n.jpg?ig_cache_key=MTIyMjk0ODY4ODg5NzI5OTIxNw%3D%3D.2.l"
				request.open("GET", "/analyzeFaceSentiment?id=" + ident + "&url=" + encodeURIComponent(thumbnailURL));
				request.send();
			}
        var pieChartDiv = document.getElementById('piechart');

		if (pieChartDiv == null) {
            console.log("The div holding the pie chart is not in the DOM");
            return;
        }
        //alert(unknown_count);

        var data = google.visualization.arrayToDataTable([
          ['Label', 'Number'],
          ['Anger',     anger_count],
          ['Contempt',      contempt_count],
          ['Disgust',     disgust_count],
          ['Fear',     fear_count],
          ['Happiness',     happiness_count],
          ['Neutral',     neutral_count],
          ['Sadness',     sadness_count],
          ['Surprise',     surprise_count],
          ['Unknown',     unknown_count]
        ]);

        var options = {
          title: 'Like vs Non Like'
        };

        var chart = new google.visualization.PieChart(pieChartDiv);

        chart.draw(data, options);
      }
    </script>
</head>

<body onload="pageLoaded()">
	<div id="header">
		<p><a id="sidebarAnchor" href="javascript:toggleSidebar()">Show Filters &gt;</a></p>
	</div>

	<div id="holder">
		<div id="container">
			<div id="userInfo">
				<img src="{{ user.profile_picture_link }}" width="64" height="64" />
				<h2>{{ user.name }}</h2>
			</div>

			{% for photo in photos %}
			<a class="photoLink" href="/photo/{{ photo.identifier }}">
				<div id="{{ photo.identifier }}" data-thumbnailURL="{{ photo.thumbnail_url }}" data-year="{{ photo.creation_date.year }}" data-month="{{ photo.creation_date.month }}" data-day="{{ photo.creation_date.day }}" class="frame">
                    <img class="emoticon" width="24" height="24"></img>
					<p class="info">{{ photo.likes }} &hearts; &nbsp; {{ photo.creation_date.strftime('%m/%d/%Y %I:%M %p') }}</p>
				</div>
			</a>
			{% endfor %}
		</div>

		<div id="sidebar">
			<p>Filter by Filter:</p>
			<ul>
				{% for filter in top_filters %}
				<li><p><a href="/stream/self?filter={{ filter.name }}">{{ filter.name }}</a></p></li>
				{% endfor %}
			</ul>
			<p>Filter by Emoji:</p>
			<ul>
				{% for emoji in top_emoji %}
				<li><p><a href="/stream/self?emoji={{ emoji.content }}">{{ emoji.content }}</a></p></li>
				{% endfor %}
			</ul>
		</div>
		<div class="clearFix"></div>
	</div>

	<div id="piechart" ></div>

	<div id="footer">
		<p><a href="/signOut">Sign Out</a></p>
	</div>
</body>
</html>
